{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'forecast/styles.css' %}">
</head>
<body>
    <!-- Передаём данные в JavaScript -->
    <script>
        window.forecastData = JSON.parse('{{ accounts_json|escapejs|default:"[]" }}'.replace(/&quot;/g, '"')) || {};
        window.forecastData.transactions = JSON.parse('{{ transactions_json|escapejs|default:"[]" }}'.replace(/&quot;/g, '"')) || [];
        window.forecastData.goals = JSON.parse('{{ goals_json|escapejs|default:"[]" }}'.replace(/&quot;/g, '"')) || [];
        window.forecastData.categories = JSON.parse('{{ categories_json|escapejs|default:"[]" }}'.replace(/&quot;/g, '"')) || [];
        window.forecastData.forecasts = JSON.parse('{{ forecasts_json|escapejs|default:"[]" }}'.replace(/&quot;/g, '"')) || [];
        console.log('forecastData loaded:', window.forecastData);
    </script>
    <div class="statistics-toggle">
        <a href="{% url 'main:index' %}" class="toggle-option">
            <div class="toggle-icon">
                <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_252_1073)">
                        <path d="M26.2858 10.5143V3.42856C26.2858 2.79739 25.774 2.28571 25.1429 2.28571H22.8572C22.226 2.28571 21.7144 2.79739 21.7144 3.42856V6.85713M21.7144 6.85713L17.428 3.42801C16.5932 2.76017 15.407 2.76017 14.5722 3.42801L2.82124 12.8288C1.50683 13.8803 2.25038 16 3.93365 16C4.91711 16 5.71436 16.7972 5.71436 17.7807V27.4286C5.71436 28.691 6.73772 29.7143 8.00008 29.7143H10.2858C11.5481 29.7143 12.5715 28.691 12.5715 27.4286V22.8571C12.5715 21.5948 13.5949 20.5714 14.8572 20.5714H17.1429C18.4053 20.5714 19.4286 21.5948 19.4286 22.8571V27.4286C19.4286 28.691 20.452 29.7143 21.7144 29.7143H24.0001C25.2625 29.7143 26.2858 28.691 26.2858 27.4286V17.7807C26.2858 16.7972 27.083 16 28.0666 16C29.7498 16 30.4933 13.8803 29.1788 12.8288L21.7144 6.85713Z" stroke="#FF5858" stroke-width="3"/>
                    </g>
                    <defs><clipPath id="clip0_252_1073"><rect width="32" height="32" fill="white"/></clipPath></defs>
                </svg>
            </div>
            <span>Главная</span>
        </a>
        <a href="#" class="toggle-option">
            <div class="toggle-icon">
                <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M29.9998 15.6667C31.1044 15.6667 32.013 14.7677 31.8724 13.6721C31.6962 12.3001 31.3389 10.9546 30.8073 9.67129C30.02 7.77053 28.866 6.04344 27.4112 4.58866C25.9564 3.13388 24.2293 1.97988 22.3285 1.19255C21.0452 0.660984 19.6997 0.303589 18.3278 0.127488C17.2322 -0.0131405 16.3332 0.895431 16.3332 2L16.3332 13.6667C16.3332 14.7712 17.2286 15.6667 18.3332 15.6667H29.9998Z" fill="#FF5858"/>
                    <mask id="path-2-inside-1_178_172" fill="white">
                        <path d="M29.3333 16.3334C30.4379 16.3334 31.3465 17.2324 31.2059 18.328C30.8989 20.7195 30.0426 23.0175 28.693 25.0373C26.9715 27.6137 24.5247 29.6217 21.662 30.8075C18.7993 31.9932 15.6493 32.3035 12.6103 31.699C9.57122 31.0945 6.77968 29.6024 4.58866 27.4114C2.39764 25.2203 0.905532 22.4288 0.301031 19.3898C-0.303471 16.3507 0.0067811 13.2007 1.19255 10.338C2.37833 7.47527 4.38636 5.02847 6.96273 3.307C8.98251 1.95742 11.2805 1.10115 13.6721 0.794166C14.7676 0.653537 15.6667 1.56212 15.6667 2.66669V14.3334C15.6667 15.4379 16.5621 16.3334 17.6667 16.3334H29.3333Z"/>
                    </mask>
                    <path d="M29.3333 16.3334C30.4379 16.3334 31.3465 17.2324 31.2059 18.328C30.8989 20.7195 30.0426 23.0175 28.693 25.0373C26.9715 27.6137 24.5247 29.6217 21.662 30.8075C18.7993 31.9932 15.6493 32.3035 12.6103 31.699C9.57122 31.0945 6.77968 29.6024 4.58866 27.4114C2.39764 25.2203 0.905532 22.4288 0.301031 19.3898C-0.303471 16.3507 0.0067811 13.2007 1.19255 10.338C2.37833 7.47527 4.38636 5.02847 6.96273 3.307C8.98251 1.95742 11.2805 1.10115 13.6721 0.794166C14.7676 0.653537 15.6667 1.56212 15.6667 2.66669V14.3334C15.6667 15.4379 16.5621 16.3334 17.6667 16.3334H29.3333Z" stroke="#FF5858" stroke-width="4" mask="url(#path-2-inside-1_178_172)"/>
                </svg>
            </div>
            <span>Учет</span>
        </a>
        <a href="#" class="toggle-option">
            <div class="toggle-icon">
                <svg viewBox="0 0 36 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 24L11.8732 11.1282C12.2164 10.6809 12.8613 10.6055 13.2984 10.9616L20.7173 17.0067C21.1484 17.3579 21.7831 17.2901 22.1302 16.8557L34 2" stroke="#FF5858" stroke-width="5"/>
                </svg>
            </div>
            <span>Прогноз</span>
        </a>
        <a href="#" class="toggle-option">
            <div class="toggle-icon">
                <svg viewBox="0 0 45 41" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.04637 21.7122C5.66684 18.2873 5.66684 12.7343 9.04637 9.30938C12.4259 5.88442 17.9052 5.88442 21.2847 9.30938L29.8424 17.982C32.546 20.722 32.546 25.1643 29.8424 27.9043L24.947 32.8656C23.5952 34.2355 21.4035 34.2355 20.0516 32.8656L9.04637 21.7122Z" fill="#FF5858"/>
                    <path d="M24.9498 32.8666C23.598 34.2365 21.4062 34.2365 20.0544 32.8666L15.1591 27.9053C12.4554 25.1654 12.4554 20.723 15.1591 17.983L23.7259 9.30099C27.1055 5.87603 32.5848 5.87603 35.9644 9.30099C39.3439 12.7259 39.3439 18.2789 35.9644 21.7039L24.9498 32.8666Z" fill="#FF5858"/>
                </svg>
            </div>
            <span>Фин. здоровье</span>
        </a>
        <a href="#" class="toggle-option">
            <div class="toggle-icon">
                <svg viewBox="0 0 32 37" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_255_1083)">
                        <path d="M20.379 29.8896L20.5717 31.8212C20.7166 33.2734 19.5787 34.5333 18.1224 34.5333H13.4577C12.0983 34.5333 10.9962 33.429 10.9962 32.0667V29.1809C10.9962 28.7404 10.7616 28.3331 10.3808 28.1128C10 27.8926 9.53087 27.8926 9.15007 28.1128L6.97412 29.3716C5.79679 30.0529 4.29134 29.6486 3.61161 28.4688L1.23058 24.3362C0.550851 23.1564 0.954235 21.6478 2.13157 20.9667L3.58404 20.1263C4.01897 19.8747 4.33636 19.4602 4.46633 18.9741C4.68816 18.1445 4.32629 17.269 3.58404 16.8396L2.19047 16.0334C1.01313 15.3522 0.609748 13.8436 1.28948 12.6638L3.61166 8.63333C4.29138 7.45354 5.79684 7.04931 6.97417 7.73045L9.15012 8.98937C9.53092 9.20966 10.0001 9.20966 10.3809 8.98937C10.7617 8.76904 10.9963 8.36189 10.9963 7.92127V4.93333C10.9963 3.57104 12.0983 2.46666 13.4578 2.46666H18.3809C19.7403 2.46666 20.8424 3.57104 20.8424 4.93333V7.62934C20.8424 8.18383 21.291 8.63333 21.8443 8.63333C21.9949 8.63333 22.1437 8.59929 22.2793 8.53372L24.9382 7.24945C26.0988 6.68878 27.4945 7.11993 28.1386 8.23809L30.2871 11.967C31.105 13.3866 30.3393 15.1958 28.7523 15.5934L28.5286 15.6494C26.3114 16.2049 25.9809 19.2246 28.0249 20.2487L29.3428 20.909C30.6957 21.5869 31.124 23.3156 30.245 24.549L27.4369 28.4885C26.6177 29.6377 24.9133 29.6377 24.0941 28.4885C22.8708 26.7722 20.1695 27.7912 20.379 29.8896Z" stroke="#FF5858" stroke-width="3"/>
                        <path d="M15.9998 23.7417C18.8887 23.7417 21.2306 21.3949 21.2306 18.5C21.2306 15.6051 18.8887 13.2583 15.9998 13.2583C13.1109 13.2583 10.769 15.6051 10.769 18.5C10.769 21.3949 13.1109 23.7417 15.9998 23.7417Z" stroke="#FF5858" stroke-width="3"/>
                    </g>
                    <defs><clipPath id="clip0_255_1083"><rect width="32" height="37" fill="white"/></clipPath></defs>
                </svg>
            </div>
            <span>Настройки</span>
        </a>

        <a href="{% url 'main:profile' %}" class="toggle-option account-menu-btn" id="accountMenuBtn">
            <div class="toggle-icon">
                <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="16" cy="10" r="6" stroke="#FF5858" stroke-width="2"/>
                <path d="M4 26C4 21.5817 9.37258 18 16 18C22.6274 18 28 21.5817 28 26" stroke="#FF5858" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <span>{{ user.username }}</span>
        </a>
    </div>


    <div class="balance-time-container">
        <div class="menu-block">
            <div class="menu-card">
        
                <div class="menu-capital">
                    <p>Доступно</p>
                    <h2><span id="balanceText">24 426,86₽</span></h2>
                </div>

                <div class="menu-accounts">
                    <div class="menu-accounts-header">
                        <div class="menu-accounts-img">
                            <svg viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 1.97839C14.9976 1.97839 18.9998 5.90821 19 10.6962C19 15.4843 14.9977 19.4149 10 19.4149C5.00229 19.4149 1 15.4843 1 10.6962C1.00017 5.90821 5.00239 1.97839 10 1.97839Z" stroke="#474747" stroke-width="2"/>
                                <path d="M10 4.37976V5.83747V6.80928M10 6.80928H10.7177C11.198 6.80928 11.6381 7.07778 11.8579 7.50495V7.50495C11.9513 7.68642 12 7.88755 12 8.09163V8.26699V8.75289M10 6.80928H8.69721C8.25011 6.80928 7.82063 6.98359 7.5 7.29518V7.29518L7.34846 7.44245C7.12569 7.65894 7 7.95636 7 8.26699V8.26699V8.75289V8.75289C7 9.06353 7.12569 9.36095 7.34846 9.57744L7.5 9.7247L7.67205 9.89191C7.88929 10.103 8.13885 10.2781 8.41131 10.4105L8.55028 10.478C8.84623 10.6218 9.17097 10.6965 9.5 10.6965V10.6965M10 10.6965H9.5M9.5 10.6965H10.3455C10.7762 10.6965 11.2013 10.7943 11.5887 10.9826L11.8272 11.0984C11.9417 11.1541 12.0465 11.2276 12.1378 11.3163V11.3163C12.3693 11.5413 12.5 11.8505 12.5 12.1734V12.6401V12.6401C12.5 13.2614 12.2486 13.8562 11.8031 14.2892L11.5 14.5837V14.5837C11.1794 14.8953 10.7499 15.0696 10.3028 15.0696H10M10 15.0696H9.47959C8.85141 15.0696 8.24799 14.8247 7.7975 14.3869V14.3869M10 15.0696V17.0133M7.5 14.0978L7.7975 14.3869M7 13.126L7.7975 14.3869" stroke="#474747" stroke-width="2"/>
                            </svg>
                        </div>
                        <h2>Счета</h2>
                    </div>
                    
                    <div class="menu-accounts-list" id="accountsList">
                        <!-- Список счетов будет отрисовываться динамически через JS -->
                    </div>

                    <div class="menu-add-btn"><button id="addAccountBtn">
                        <p>Добавить счет</p>
                    </button>
                    </div>
                    <div class="modal" id="accountModal">
                        <div class="modal-content">
                            <span class="close" id="closeAccountModal">&times;</span>
                            <h2 id="accountModalTitle">Добавить счет</h2>
                            <input type="text" id="accountName" placeholder="Название счета">
                            <input type="number" id="accountAmount" placeholder="Сумма">
                            <select id="accountType" class="account-select">
                                <option value="">Выберите тип счета</option>
                                <option value="deposit">Вклад</option>
                                <option value="debit">Дебетовый счет</option>
                                <option value="credit">Кредитный счет</option>
                                <option value="savings">Накопительный счет</option>
                                <option value="investment">Инвестиционный счет</option>
                                <option value="cash">Наличные</option>
                            </select>
                            <input type="text" id="accountDesc" placeholder="Описание (опционально)">
                            <div style="display:flex;gap:.5em;">
                                <button id="saveAccount">Сохранить</button>
                                <button id="deleteAccount" style="background:#fff;color:#ff5858;border:1px solid #ff5858;display:none;">Удалить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="time-container">
            <button class="chart-btn active" data-range="year">Год</button>
            <button class="chart-btn" data-range="month">Месяц</button>
            <button class="chart-btn" data-range="week">Неделя</button>
        </div>
    </div>
    


        
    <div class="main-wrapper">

        <div class="main-wrapper-container">
                <div class="chart-container">
            <h2>Доходы, расходы и баланс</h2>
            <div class="chart-controls">
                
            </div>
            <canvas id="incomeExpenseByMonthChart"></canvas>
            </div>

            <div class="chart-container">
            <h2>Распределение расходов</h2>
            <canvas id="expensesByCategoryChart"></canvas>
            </div>

            <div class="chart-container">
            <h2>Динамика накоплений</h2>
            <canvas id="balanceOverTimeChart"></canvas>
            </div>
        </div>

        

<div class="planning-container" id="planningContainer">
    <div class="planning-header">
        <div>
            <h2>Финансовое планирование: <span id="currentMonth"></span></h2>
            <p class="subtext">Анализируйте доходы, расходы и цели по месяцам</p>
        </div>
        <div class="month-nav">
            <button id="prevMonth">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

            <button id="nextMonth">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Сводка месяца -->
    <div class="summary-section">
        <div class="summary-card income">
            <h4>Доходы</h4>
            <span id="totalIncome">0₽</span>
        </div>
        <div class="summary-card expense">
            <h4>Расходы</h4>
            <span id="totalExpense">0₽</span>
        </div>
        <div class="summary-card balance">
            <h4>Остаток</h4>
            <span id="monthlySurplus">0₽</span>
        </div>
        <div class="summary-card forecast">
            <h4>Прогноз</h4>
            <span id="forecastEnd">0₽</span>
        </div>
    </div>

    <!-- Категории -->
    <div class="section">
        <div class="section-title">Бюджет по категориям</div>
        <div id="categoryList"></div>
        <div class="add-btn" id="addCategoryBtn">[+ Добавить категорию]</div>
    </div>

    <!-- Цели -->
    <div class="section">
        <div class="section-title">Финансовые цели</div>
        <div id="goalsList"></div>
        <div class="add-btn" id="addGoalBtn">[+ Новая цель]</div>
    </div>


    <!-- Аналитика -->
    <div class="analitic-section">
        <div class="section-title">Аналитика месяца</div>
        <canvas id="categoryProgressChart" height="200"></canvas>
        <canvas id="cashflowForecastChart" height="200"></canvas>
    </div>
</div>

<!-- Модальное окно для категорий -->
<div class="modal" id="categoryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Установить бюджет для категории</h3>
        </div>
        <div class="modal-body">
            <select id="catSelect" class="category-select">
                <option value="">Выберите категорию</option>
            </select>
            <input type="number" id="catBudget" placeholder="Бюджет на месяц (₽)" min="0">
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('categoryModal')">Отмена</button>
            <button class="btn-primary" id="saveCategory">Сохранить</button>
        </div>
    </div>
</div>

<div class="modal" id="goalModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Новая цель</h3>
        </div>
        <div class="modal-body">
            <input type="text" id="goalName" placeholder="Название (например, Отпуск)">
            <input type="number" id="goalTarget" placeholder="Сумма цели (₽)">
            <input type="number" id="goalCurrent" placeholder="Уже накоплено (₽)" value="0">
            
            <div class="accounts-section">
                <label class="section-label">Подключить счета:</label>
                <div id="goalAccounts" class="accounts-checkbox-list">
                    <!-- Счета будут добавлены динамически -->
                </div>
                <label style="display: flex; align-items: center; gap: 0.5em; margin-top: 1em; cursor: pointer;">
                    <input type="checkbox" id="goalOnlyAccounts" style="width: auto;">
                    <span>Учитывать только счета (без общих средств)</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('goalModal')">Отмена</button>
            <button class="btn-primary" id="saveGoal">Сохранить</button>
        </div>
    </div>
</div>

<div class="modal" id="paymentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Новый платеж</h3>
        </div>
        <div class="modal-body">
            <input type="text" id="payName" placeholder="Название">
            <input type="number" id="payAmount" placeholder="Сумма">
            <input type="date" id="payDate">
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('paymentModal')">Отмена</button>
            <button class="btn-primary" id="savePayment">Сохранить</button>
        </div>
    </div>
</div>




<script src="{% static 'forecast/script.js' %}"></script>

</body>
</html>